const path = require('path');
require('dotenv').config({ path: path.join(__dirname, '../../.env') });

class SecureConfig {
    constructor() {
        this.validateEnvironment();
    }

    // === إعدادات الأمان ===
    get security() {
        return {
            secretKey: process.env.SECRET_KEY || 'fallback-secret-change-in-production',
            encryptionKey: process.env.ENCRYPTION_KEY || 'fallback-encryption-key',
            jwtExpiry: process.env.JWT_EXPIRY || '24h',
            corsOrigin: process.env.CORS_ORIGIN || 'http://localhost:3000'
        };
    }

    // === إعدادات قاعدة البيانات ===
    get database() {
        return {
            url: process.env.DATABASE_URL || 'mongodb://localhost:27017/trading',
            options: {
                useNewUrlParser: true,
                useUnifiedTopology: true,
                retryWrites: true
            }
        };
    }

    // === إعدادات الخادم ===
    get server() {
        return {
            port: parseInt(process.env.PORT || '5000'),
            environment: process.env.NODE_ENV || 'development',
            rateLimit: {
                windowMs: 15 * 60 * 1000, // 15 دقيقة
                max: parseInt(process.env.RATE_LIMIT_MAX || '100')
            }
        };
    }

    // === إعدادات التداول ===
    get trading() {
        return {
            exchanges: {
                binance: {
                    apiKey: process.env.BINANCE_API_KEY || '',
                    apiSecret: process.env.BINANCE_API_SECRET || '',
                    testnet: process.env.BINANCE_TESTNET === 'true'
                },
                bybit: {
                    apiKey: process.env.BYBIT_API_KEY || '',
                    apiSecret: process.env.BYBIT_API_SECRET || '',
                    testnet: process.env.BYBIT_TESTNET === 'true'
                }
            },
            riskManagement: {
                maxPositionSize: parseFloat(process.env.MAX_POSITION_SIZE || '1000'),
                dailyLossLimit: parseFloat(process.env.DAILY_LOSS_LIMIT || '500'),
                maxLeverage: parseInt(process.env.MAX_LEVERAGE || '10')
            }
        };
    }

    // === التحقق من البيئة ===
    validateEnvironment() {
        const required = ['SECRET_KEY'];
        const missing = required.filter(key => !process.env[key]);
        
        if (missing.length > 0) {
            console.warn('⚠️  تحذير: المتغيرات البيئية التالية مفقودة:', missing);
            console.log('يرجى تعيينها في ملف .env');
        }
        
        return missing.length === 0;
    }

    // === الحصول على الإعدادات ===
    getConfig() {
        return {
            security: this.security,
            database: this.database,
            server: this.server,
            trading: this.trading
        };
    }
}

module.exports = new SecureConfig().getConfig();
